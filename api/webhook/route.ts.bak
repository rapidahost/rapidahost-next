// ... หลังจากตรวจสอบว่า event.type === 'checkout.session.completed'

const metadata = session.metadata || {}
const { clientId, invoiceId, password } = await createWHMCSClientAndInvoice({
  email: session.customer_email!,
  name: metadata.name || '',
  plan_id: metadata.plan_id,
  payment_method: 'stripe',
  promocode: metadata.promocode || undefined
})

// ส่ง Email แจ้งข้อมูล
await fetch(`${process.env.NEXT_PUBLIC_SITE_URL}/api/send-email`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    to: session.customer_email,
    name: metadata.name || '',
    email: session.customer_email,
    password // ถ้าลูกค้าใหม่, จะแนบรหัสผ่านไปด้วย
  })
})

// ... (Webhook Logic ด้านบนเหมือนเดิม)

case 'checkout.session.completed': {
  const session = event.data.object;

  const metadata = session.metadata || {};
  const clientEmail = session.customer_email;

  const result = await createWHMCSClientAndInvoice({
    email: clientEmail,
    payment_method: 'stripe',
    plan_id: metadata.plan_id,
    promocode: metadata.promocode,
    billingcycle: metadata.billingcycle
  });

  // ส่ง Welcome Email หลังสมัครสำเร็จ
  try {
    await fetch(`${process.env.NEXT_PUBLIC_BASE_URL}/api/email/welcome`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        clientId: result.clientId,
        password: result.password || ''
      })
    });
  } catch (e) {
    console.error('Send Welcome Email failed', e);
  }

  return res.status(200).json({ received: true });
}
